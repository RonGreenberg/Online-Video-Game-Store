<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colman Games</title>

    <!-- Font Awesome CSS, used for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- importing our own CSS files -->
    <link rel="stylesheet" href="public/css/table.css">
    <link rel="stylesheet" href="public/css/style.css">
</head>
<body>
    <div class="container">
        <!-- header is empty, but the CSS creates a background image in it -->
        <header>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>Colman Games</h2>
            <ul>
                <li><a href="#dashboard"><i class="fa fa-bar-chart fa-lg"></i>Dashboard</a></li>
                <li><a href="#games"><i class="fa fa-gamepad fa-lg"></i>Games</a></li>
                <li><a href="#customers"><i class="fa fa-user fa-lg"></i>Customers</a></li>
                <li><a href="#orders"><i class="fa fa-shopping-cart fa-lg"></i>Orders</a></li>
                <li><a href="#about"><i class="fa fa-info-circle fa-lg"></i>About</a></li>
            </ul>
        </aside>

        <section>
            <!-- All pages initially hidden -->

            <div class="page" id="dashboard" style="display: none;"><h1>Dashboard</h1></div>

            <div class="page" id="games" style="display: none;">
                <!-- <h1>Games</h1> -->
                <button class="btn-add-new">Add New</button>
                <button class="btn-search">Search</button>
                <div class="popup-overlay">
                    <div class="popup-content">
                        <form method="post">
                            <label for="gameID">gameID</label>
                            <input type="text" name="gameID" id="gameID" />
                            <label for="gameName">Name</label>
                            <input type="text" name="gameName" id="gameName" />
                            <label for="description">description</label>
                            <input type="text" name="description" id="description" />
                            <label for="unitPrice">unitPrice</label>
                            <input type="text" name="unitPrice" id="unitPrice" />
                            <label for="developer">developer</label>
                            <input type="text" name="developer" id="developer" />
                            <label for="version">version</label>
                            <input type="text" name="version" id="version" />
                            <label for="releaseDate">releaseDate</label>
                            <input type="text" name="releaseDate" id="releaseDate" />
                            <label for="genre">genre</label>
                            <input type="text" name="genre" id="genre" />
                            <label for="platform">platform</label>
                            <input type="text" name="platform" id="platform" />
                            <label for="licenseType">licenseType</label>
                            <input type="text" name="licenseType" id="licenseType" />
                            <button type="button" class="btn-cancel">Cancel</button>
                            <button type="submit">Confirm</button>
                        </form>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>gameID</th>
                            <th>gameName</th>
                            <th>description</th>
                            <th>unitPrice</th>
                            <th>developer</th>
                            <th>version</th>
                            <th>releaseDate</th>
                            <th>genre</th>
                            <th>platform</th>
                            <th>licenseType</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="page" id="customers" style="display: none;">
                <button class="btn-add-new">Add New</button>
                <button class="btn-search">Search</button>
                <div class="popup-overlay">
                    <div class="popup-content">
                        <form method="post">
                            <label for="customerID">ID</label>
                            <input type="text" name="customerID" id="customerID" />
                            <label for="customerName">Name</label>
                            <input type="text" name="customerName" id="customerName" />
                            <label for="address">Address</label>
                            <input type="text" name="address" id="address" />
                            <label for="email">Email</label>
                            <input type="text" name="email" id="email" />
                            <button type="button" class="btn-cancel">Cancel</button>
                            <button type="submit">Confirm</button>
                        </form>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="page" id="orders" style="display: none;"><h1>Orders</h1></div>

            <div class="page" id="about" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Address</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </section>

        <footer>
            <div>Ron Greenberg</div>
            <div>Yonatan Birman</div>
            <div>Aviv Keinan</div>
            <div>Itamar Azmoni</div>
        </footer>
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="public/js/main.js"></script>
    <script type="text/javascript">
        // selecting a page when the document is fully loaded
        $(document).ready(function() {
            selectPage(window.location.hash);
        });

        // event handler for clicking Add New buttons (Add New buttons in all pages should use this class)
        $('.btn-add-new').click(function() {
            var popup = $(this).closest('.page').find('.popup-overlay'); // finding the popup overlay from the same page where the button was clicked
            $(popup.find('button')[1]).html("Add"); // change the name of the button
            popup.css('display', 'block'); // displaying the popup
            popup.find('form')[0].reset(); // searching the form among the popup element's children, and clearing its input boxes
        });

        // event handler for clicking Search buttons (Search buttons in all pages should use this class)
        $('.btn-search').click(function() {
            var popup = $(this).closest('.page').find('.popup-overlay'); // finding the popup overlay from the same page where the button was clicked
            $(popup.find('button')[1]).html("Search"); // change the name of the button
            popup.css('display', 'block'); // displaying the popup
            popup.find('form')[0].reset(); // searching the form among the popup element's children, and clearing its input boxes
        });

        // event handler for clicking Cancel buttons (Cancel buttons in all pages should use this class)
        $('.btn-cancel').click(function() {
            var popup = $(this).closest('.page').find('.popup-overlay');
            popup.css('display', 'none'); // hiding the popup
            popup.find('form')[0].removeAttribute("data-id"); // removing the data-id attribute in case we cancel an edit (there's no problem to remove it if it doesn't exist)
        });

        /* Event handler for clicking an Edit button. Note that we can't use $(".btn-edit").click(...), because it will bind the event only to the
         * matching elements that already exist in the page by now. Since the Edit buttons are created dynamically, this would not work.
         * The same applies for Delete buttons, as you can see below.
         */
        $(document).on("click", ".btn-edit", function() {
            var popup = $(this).closest('.page').find('.popup-overlay'); // finding the popup overlay from the same page where the button was clicked
            var row = $(this).parent().siblings('td'); // the button is stored inside a td, so we get to its parent and take its td siblings, which contain the actual data
            for (var i = 0; i < row.length; i++) {
                // searching input fields whose id is equal to the column name we stored in the current td, and setting their text to the text from the td
                popup.find('input[id="' + row[i].dataset.colname + '"]').val(row[i].innerHTML);
            }

            // when submitting the form, we also need to send the id of the object to update. So we store it as an attribute of the form just like we did inside the Edit button.
            popup.find('form')[0].setAttribute('data-id', $(this).attr('data-id'));
            $(popup.find('button')[1]).html("Edit"); // change the name of the button
            popup.css('display', 'block'); // displaying the popup
        });

        // event handler for clicking a Delete button
        $(document).on("click", ".btn-delete", function() {
            // asking the user with browser's built-in popup. If OK was selected, confirm() returns true
            if (confirm("Are you sure you want to delete this record?")) {
                var page = $(this).closest('.page'); // finding the page that contains this form
                var collection = page.attr('id'); // the id of the page should match the name of the collection in MongoDB (which could make for a nice security vulnerability...)
                
                // sending an HTTP POST request to the appropriate route in the server, putting the object id in the request body
                $.post('delete?collection=' + collection, "id=" + $(this).attr('data-id'), function(data) {
                    // if the request is successful, we refresh the table
                    readAndFillTable(page, collection);
                });
            }
        });

        // event handler for submitting the form to the server (when the submit/confirm button is clicked). Could be a new record or an edited one
        $('form').on('submit', function(event) {
            event.preventDefault();

            var page = $(this).closest('.page'); 
            var collection = page.attr('id');

            var textFields = $(this).find('input'); // get all input elements

            var allEmpty = true; // check if all inputs are empty
            var allFilled = true;
            for(var i = 0; i < textFields.length; i++)
            {
                if(textFields.eq(i).val() != "")
                {
                    allEmpty = false;
                } else
                    allFilled = false;
            }
            if(allEmpty) // if all inputs are empty, refill the table
            {
                readAndFillTable(page, collection);
            }
            

            if($(this).find('button')[1].innerHTML == "Search") // check if this is a search popup
            {
                var table = $(this).closest('.page').find('table'); // gets the table
                for(var i = 1; i < $(table).find('tr').length; i++) // run on the rows
                {
                    var row = $(table).find('tr')[i];
                    for(var j = 0; j < $(row).find('td').length-1; j++) // run on the columns
                    {
                        if(textFields.eq(j).val() != "" && textFields.eq(j).val() != $(row).find('td')[j].innerHTML) // remove the row if the input is not empty and not equal to the value in the table
                        {
                            row.remove();
                            i--;
                            break;
                        }
                    }
                }
            }else{ // if its not search popup(it might be create popup or edit popup)
                
                if(!allFilled) // if not all inputs are filled, give alert, then return
                {
                    alert("Not all fields are filled.");
                    return;
                }
                var route;
                if ($(this).attr("data-id")) { // if the form contains a data-id attribute, it means we got here as a result of editing
                    route = 'update?collection=' + collection + "&id=" + $(this).attr("data-id");
                } else { // else, we want to add a new record
                    route = 'create?collection=' + collection;
                }
                
                // sending an HTTP POST request to the appropriate route in the server
                $.post(route, $(this).serialize(), function(data) {
                    // if the request is successful, we hide the popup and refresh the table
                    page.find('.popup-overlay').css('display', 'none');
                    readAndFillTable(page, collection);
                });
            }
            page.find('.popup-overlay').css('display', 'none');
            $(this).removeAttr("data-id"); // removing the data-id attribute, as the operation is finished
        });
    </script>
</body>
</html>