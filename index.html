<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colman Games</title>

    <link rel="shortcut icon" href="#">
    
    <!-- Font Awesome CSS, used for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- importing our own CSS files -->
    <link rel="stylesheet" href="public/css/table.css">
    <link rel="stylesheet" href="public/css/style.css">
</head>
<body>
    <div class="container">
        <!-- header is empty, but the CSS creates a background image in it -->
        <header>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>Colman Games</h2>
            <ul>
                <li><a href="#dashboard"><i class="fa fa-bar-chart fa-lg"></i>Dashboard</a></li>
                <li><a href="#games"><i class="fa fa-gamepad fa-lg"></i>Games</a></li>
                <li><a href="#customers"><i class="fa fa-user fa-lg"></i>Customers</a></li>
                <li><a href="#orders"><i class="fa fa-shopping-cart fa-lg"></i>Orders</a></li>
                <li><a href="#about"><i class="fa fa-info-circle fa-lg"></i>About</a></li>
            </ul>
        </aside>

        <section>
            <!-- All pages initially hidden -->

            <div class="page" id="dashboard" style="display: none;"><h1>Dashboard</h1></div>

            <div class="page" id="games" style="display: none;">
                <button class="btn-add-new">Add New</button>
                <button class="btn-search">Search</button>
                <button class="btn-clear-search">Clear Search</button>
                <div class="popup-overlay">
                    <div class="popup-content">
                        <form method="post">
                            <label for="gameID">ID</label>
                            <input type="text" name="gameID" id="gameID" required />
                            <label for="gameName">Name</label>
                            <input type="text" name="gameName" id="gameName" required />
                            <label for="description">Description</label>
                            <input type="text" name="description" id="description" required />
                            <label for="unitPrice">Unit Price</label>
                            <input type="text" name="unitPrice" id="unitPrice" required />
                            <label for="developer">Developer</label>
                            <input type="text" name="developer" id="developer" required />
                            <label for="version">Version</label>
                            <input type="text" name="version" id="version" required />
                            <label for="releaseDate">Release Date</label>
                            <input type="date" name="releaseDate" id="releaseDate" required />
                            <label for="genre">Genre</label>
                            <input type="text" name="genre" id="genre" required />
                            <label for="platform">Platform</label>
                            <input type="text" name="platform" id="platform" required />
                            <label for="licenseType">License Type</label>
                            <input type="text" name="licenseType" id="licenseType" required />
                            <label for="image" class="hide-on-search">Upload Image:</label>
                            <input type="file" accept="image/*" name="image" id="image" class="hide-on-search" />
                            <label for="trailer" class="hide-on-search">Upload Trailer:</label>
                            <input type="file" accept=".mp4" name="trailer" id="trailer" class="hide-on-search" />
                            <button type="button" class="btn-cancel">Cancel</button>
                            <button type="submit">Confirm</button>
                        </form>
                    </div>
                </div>
                <div class="video-overlay">
                    <video id="gameTrailer" width="500" controls> <!-- height is auto-adjusted according to video aspect ratio, using height: auto in CSS -->
                        <source src="" type="video/mp4">
                    </video>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Unit Price ($)</th>
                            <th>Developer</th>
                            <th>Version</th>
                            <th>Release Date</th>
                            <th>Genre</th>
                            <th>Platform</th>
                            <th>License Type</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="page" id="customers" style="display: none;">
                <button class="btn-add-new">Add New</button>
                <button class="btn-search">Search</button>
                <button class="btn-clear-search">Clear Search</button>
                <div class="popup-overlay">
                    <div class="popup-content">
                        <form method="post">
                            <label for="customerID">ID</label>
                            <input type="text" name="customerID" id="customerID" required />
                            <label for="customerName">Name</label>
                            <input type="text" name="customerName" id="customerName" required />
                            <label for="address">Address</label>
                            <input type="text" name="address" id="address" required />
                            <label for="email">Email</label>
                            <input type="text" name="email" id="email" required />
                            <button type="button" class="btn-cancel">Cancel</button>
                            <button type="submit">Confirm</button>
                        </form>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="page" id="orders" style="display: none;">
                <button class="btn-add-new">Add New</button>
                <button class="btn-search">Search</button>
                <button class="btn-clear-search">Clear Search</button>
                <div class="popup-overlay">
                    <div class="popup-content">
                        <form method="post">
                            <label for="orderNumber">Order number</label>
                            <input type="text" name="orderNumber" id="orderNumber" required />
                            <label for="customerID">Customer ID</label>
                            <input type="text" name="customerID" id="customerID" required />
                            <label for="paymentMethod">Payment method</label>
                            <input type="text" name="paymentMethod" id="paymentMethod" required />
                            <label for="orderDate">Order date</label>
                            <input type="date" name="orderDate" id="orderDate" value="today(js will change this)" min="2017-04-01" max="today(js will change this)" required />

                            <button type="button" class="btn-cancel">Cancel</button>
                            <button type="submit">Confirm</button>
                        </form>
                    </div>
                </div>
            
                <table class="table table-hover table-expandable">
                    <thead>
                        <tr>
                            <th>Order number</th>
                            <th>Customer ID</th>
                            <th>Payment method</th>
                            <th>Order date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="page" id="about" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Address</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </section>

        <footer>
            <div>Ron Greenberg</div>
            <div>Yonatan Birman</div>
            <div>Aviv Keinan</div>
            <div>Itamar Azmoni</div>
        </footer>
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="public/js/main.js"></script>
    <script type="text/javascript">
        // selecting a page when the document is fully loaded
        $(document).ready(function() {
            selectPage(window.location.hash);
        });

        // event handler for clicking Add New buttons (Add New buttons in all pages should use this class)
        $('.btn-add-new').click(function() {
            var popup = $(this).closest('.page').find('.popup-overlay'); // finding the popup overlay from the same page where the button was clicked
            $(popup.find('button')[1]).html("Add"); // change the name of the button
            popup.css('display', 'block'); // displaying the popup
            popup.find('form')[0].reset(); // searching the form among the popup element's children, and clearing its input boxes
        });

        // event handler for clicking Search buttons (Search buttons in all pages should use this class)
        $('.btn-search').click(function() {
            var popup = $(this).closest('.page').find('.popup-overlay'); // finding the popup overlay from the same page where the button was clicked
            $(popup.find('button')[1]).html("Search"); // change the name of the button
            popup.css('display', 'block'); // displaying the popup

            popup.find('form').eq(0).find('[class="hide-on-search"]').hide(); // hiding elements that should be hidden when searching (currently image and video upload in Games form)
            popup.find('form')[0].reset();
            /* Since we want to allow filling only some of the fields when searching, we can temporarily turn on the novalidate property of the form
             * so that it doesn't check for required inputs.
             */
            popup.find('form').eq(0).prop('noValidate', true); // just like popup.find('form')[0], only that it remains a jQuery object
        });
        
        $('.btn-clear-search').click(function() {
            displayTable($(this).closest('.page').find("form")[0]);
        });

        // event handler for clicking Cancel buttons (Cancel buttons in all pages should use this class)
        $('.btn-cancel').click(function() {
            var popup = $(this).closest('.page').find('.popup-overlay');
            popup.css('display', 'none'); // hiding the popup
            popup.find('form').eq(0).find('[class="hide-on-search"]').show(); // showing elements that may have been hidden by search
            popup.find('form')[0].removeAttribute("data-id"); // removing the data-id attribute in case we cancel an edit (there's no problem to remove it if it doesn't exist)
            popup.find('form')[0].removeAttribute('noValidate'); // removing the noValidate attribute, added in case we have clicked search button
        });

        /* Event handler for clicking an Edit button. Note that we can't use $(".btn-edit").click(...), because it will bind the event only to the
         * matching elements that already exist in the page by now. Since the Edit buttons are created dynamically, this would not work.
         * The same applies for Delete buttons, as you can see below.
         */
        $(document).on("click", ".btn-edit", function() {
            var popup = $(this).closest('.page').find('.popup-overlay'); // finding the popup overlay from the same page where the button was clicked
            popup.find('form')[0].reset();
            var row = $(this).parent().siblings('td'); // the button is stored inside a td, so we get to its parent and take its td siblings, which contain the actual data
            for (var i = 0; i < row.length; i++) {
                // searching input fields whose id is equal to the column name we stored in the current td, and setting their text to the text from the td
                popup.find('input[id="' + row[i].dataset.colname + '"]').val(row[i].innerHTML);
            }

            // when submitting the form, we also need to send the id of the object to update. So we store it as an attribute of the form just like we did inside the Edit button.
            popup.find('form')[0].setAttribute('data-id', $(this).attr('data-id'));
            $(popup.find('button')[1]).html("Edit"); // change the name of the button
            popup.css('display', 'block'); // displaying the popup
        });

        // event handler for clicking a Delete button
        $(document).on("click", ".btn-delete", function() {
            // asking the user with browser's built-in popup. If OK was selected, confirm() returns true
            if (confirm("Are you sure you want to delete this record?")) {
                var page = $(this).closest('.page'); // finding the page that contains this form
                var collection = page.attr('id'); // the id of the page should match the name of the collection in MongoDB (which could make for a nice security vulnerability...)
                
                // sending an HTTP POST request to the appropriate route in the server, putting the object id in the request body
                $.post('delete?collection=' + collection, "id=" + $(this).attr('data-id'), function(data) {
                    // if the request is successful, render the updated page
                    renderPage(collection);
                });
            }
        });

        function displayTable(frm)
        {
            var table = $(frm).closest('.page').find('table'); // gets the table
            
            for(var i = 1; i < $(table).find('tr').length; i++) // run on the rows
            {
                var row = $(table).find('tr')[i];
                if(!($(row).find('td')[0].hasAttribute("colspan"))) // depends on the fact that in Orders table, rows containing game details (which should be hidden) use the colspan attribute
                    row.style.display="table-row"; // displaying the row
                else
                    row.style.display="none";
            }
        }

        // event handler for submitting the form to the server (when the submit/confirm button is clicked). Could be a new record or an edited one
        $('form').on('submit', function(event) {
            event.preventDefault();

            var page = $(this).closest('.page');
            var collection = page.attr('id');

            var textFields = $(this).find('input'); // get all input elements

            displayTable($(this)); // displaying the entire table by default. in case of a blank search, no rows will be hidden

            if ($(this).find('button')[1].innerHTML == "Search") { // check if this is a search popup                 
                var rows = $(this).closest('.page').find('table tbody tr'); // gets the rows
                for (var i = 0; i < rows.length; i++) {
                    var cells = rows.eq(i).find('td[data-colname]'); // selecting only cells that have a data-colname attribute (not image/video for example)
                    for (var j = 0; j < cells.length - 1; j++) { // run on the columns (not including the last edit/delete column)
                        // the following check will work for dates as well since both the input fields and the table cells now use the yyyy-mm-dd format
                        if (textFields.eq(j).val() != "" &&  cells[j].innerHTML.toLowerCase().indexOf(textFields.eq(j).val().toLowerCase()) <= -1) {
                            rows[i].style.display = "none"; // row disappears if the input is not empty and not equal to the value in the table
                            break;
                        }
                    }
                }
                $(this).removeAttr('noValidate'); // removing the noValidate attribute, now that the search is finished
                page.find('.popup-overlay').css('display', 'none'); // hiding the popup
                popup.find('form').eq(0).find('[class="hide-on-search"]').show(); // showing elements that may have been hidden by search
            } else { // if its not search popup (it might be create popup or edit popup)
                // var allFilled = true; // check if all inputs are filled
                // var requiredFields = $(this).find('input[required]');
                // requiredFields.each(function() {
                //     if ($(this).val() == '') {
                //         allFilled = false;
                //     }
                // });
                // if (!allFilled) { // if not all inputs are filled, give alert, then return
                //     alert("Not all fields are filled.");
                //     return;
                // }

                var route;
                if ($(this).attr("data-id")) { // if the form contains a data-id attribute, it means we got here as a result of editing
                    route = 'update?collection=' + collection + "&id=" + $(this).attr("data-id");
                } else { // else, we want to add a new record
                    route = 'create?collection=' + collection;
                }
                
                // sending an HTTP POST request to the appropriate route in the server
                $.ajax({
                    method: "POST",
                    url: route,
                    data: new FormData(this), // FormData enables sending key-value pairs representing form fields and their values, using the multipart/form-data encoding, which is required for sending <input type="file"> elements
                    processData: false, // must be set to false so that the FormData will not be processed and transformed into a query string, which would fail
                    contentType: false, // forcing jQuery not to add a Content-Type header to the HTTP request, which would mess up the structure of our multipart/form-data request
                    success: function(data) {
                        // if the request is successful, hide the popup and render the updated page
                        page.find('.popup-overlay').css('display', 'none');
                        renderPage(collection);
                    }
                });
            }
            
            $(this).removeAttr("data-id"); // removing the data-id attribute, as the operation is finished
        });

        $(document).on("click", ".btn-play", function() {
            $('#gameTrailer > source').attr('src', $(this).attr('data-src')); // setting the video source from the source field stored in the play button
            document.getElementById('gameTrailer').load(); // reloading the video element (must use pure DOM instead of jQuery)
            $(this).closest('.page').find('.video-overlay').css('display', 'block'); // displaying the video popup
        });

        $('.video-overlay').click(function(e) {
            // checking that we actually clicked the overlay and not the video itself
            if ($(e.target).is('.video-overlay')) {
                document.getElementById('gameTrailer').pause(); // pausing the video
                $(this).css('display', 'none'); // hiding the overlay (and the video) when clicking on it
            }
        });
    </script>
</body>
</html>